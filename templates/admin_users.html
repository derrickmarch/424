{% extends "base.html" %}
{% block title %}User Management{% endblock %}
{% block page_name %}admin_users{% endblock %}

{% block content %}
<h1>Admin - User Management</h1>
<p>Manage application users. Only admins can access this page.</p>

<div class="card">
  <h2>Create New User</h2>
  <form id="createUserForm" onsubmit="return createUser(event)">
    <div class="grid">
      <div>
        <label>Username</label>
        <input type="text" id="new_username" required />
      </div>
      <div>
        <label>Password</label>
        <input type="password" id="new_password" required />
      </div>
      <div>
        <label>Full Name</label>
        <input type="text" id="new_full_name" />
      </div>
      <div>
        <label>Email</label>
        <input type="email" id="new_email" />
      </div>
      <div>
        <label>Is Admin</label>
        <input type="checkbox" id="new_is_admin" />
      </div>
      <div>
        <label>Active</label>
        <input type="checkbox" id="new_is_active" checked />
      </div>
    </div>
    <button type="submit" class="btn">Create User</button>
  </form>
</div>

<div class="card">
  <h2>Users</h2>
  <div class="controls" style="display:flex; gap: 0.5rem; align-items:center; margin-bottom: 0.5rem;">
    <input type="text" id="search_query" placeholder="Search username, email, name" style="flex:1; padding:0.5rem;"/>
    <button class="btn" onclick="applySearch()">Search</button>
    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
  </div>
  <div id="usersTableContainer">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Admin</th>
          <th>Active</th>
          <th>Created</th>
          <th>Last Login</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
    <div class="pagination" style="display:flex; justify-content: space-between; align-items:center; margin-top:0.5rem;">
      <div id="page_info"></div>
      <div>
        <button class="btn btn-secondary" onclick="prevPage()">Prev</button>
        <button class="btn btn-secondary" onclick="nextPage()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Simple password reset modal -->
<div id="passwordModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Reset Password</h3>
    <input type="password" id="reset_password_input" placeholder="New Password" />
    <div style="margin-top:1rem;">
      <button class="btn" onclick="confirmResetPassword()">Reset</button>
      <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
    </div>
  </div>
</div>

<style>
  .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 1rem; }
  .table { width: 100%; border-collapse: collapse; }
  .table th, .table td { border-bottom: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
  .badge { padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
  .badge.green { background: #dcfce7; color: #166534; }
  .badge.gray { background: #e5e7eb; color: #374151; }
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; }
  .modal-content { background: white; padding: 1rem; border-radius: 0.5rem; width: 300px; }
  .btn { background: #2563eb; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 0.375rem; cursor: pointer; }
  .btn-secondary { background: #6b7280; }
  .btn-danger { background: #dc2626; }
  .btn-warning { background: #f59e0b; }
  .btn-ghost { background: transparent; color: #2563eb; }
  .actions button { margin-right: 0.25rem; }
  .pagination button { margin-left: 0.25rem; }
</style>
{% endblock %}

{% block extra_js %}
<script>
let users = [];
let resetUserId = null;
let currentPage = 1;
let pageSize = 10;
let totalUsers = 0;
let currentQuery = '';

async function fetchUsers() {
  const params = new URLSearchParams();
  params.set('page', String(currentPage));
  params.set('page_size', String(pageSize));
  if (currentQuery) params.set('q', currentQuery);
  const res = await fetch('/api/users/?' + params.toString());
  if (!res.ok) {
    alert('Failed to load users');
    return;
  }
  const data = await res.json();
  users = data.items || [];
  totalUsers = data.total || 0;
  renderUsers();
}

function renderUsers() {
  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = '';
  users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.id}</td>
      <td>${u.username}</td>
      <td><input type="text" value="${u.full_name || ''}" data-field="full_name" data-id="${u.id}" class="inline-input"/></td>
      <td><input type="email" value="${u.email || ''}" data-field="email" data-id="${u.id}" class="inline-input"/></td>
      <td><input type="checkbox" ${u.is_admin ? 'checked' : ''} data-field="is_admin" data-id="${u.id}"/></td>
      <td><input type="checkbox" ${u.is_active ? 'checked' : ''} data-field="is_active" data-id="${u.id}"/></td>
      <td>${u.created_at ? new Date(u.created_at).toLocaleString() : ''}</td>
      <td>${u.last_login_at ? new Date(u.last_login_at).toLocaleString() : ''}</td>
      <td class="actions">
        <button class="btn btn-warning" onclick="openPasswordModal(${u.id})">Reset PW</button>
        <button class="btn" onclick="saveRow(${u.id})">Save</button>
        <button class="btn btn-danger" onclick="deleteUser(${u.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  const info = document.getElementById('page_info');
  const start = totalUsers === 0 ? 0 : (currentPage - 1) * pageSize + 1;
  const end = Math.min(currentPage * pageSize, totalUsers);
  info.textContent = `${start}-${end} of ${totalUsers}`;
}

async function createUser(e) {
  e.preventDefault();
  const payload = {
    username: document.getElementById('new_username').value.trim(),
    password: document.getElementById('new_password').value,
    full_name: document.getElementById('new_full_name').value.trim() || null,
    email: document.getElementById('new_email').value.trim() || null,
    is_admin: document.getElementById('new_is_admin').checked,
    is_active: document.getElementById('new_is_active').checked,
  };
  const res = await fetch('/api/users/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    alert('Failed to create user: ' + (err.detail || res.statusText));
    return false;
  }
  const newUser = await res.json();
  // Reload first page to include new user in consistent position
  currentPage = 1;
  await fetchUsers();
  e.target.reset();
  return false;
}

async function saveRow(userId) {
  const inputs = document.querySelectorAll(`[data-id="${userId}"]`);
  const payload = {};
  inputs.forEach(el => {
    const field = el.getAttribute('data-field');
    if (el.type === 'checkbox') {
      payload[field] = el.checked;
    } else {
      payload[field] = el.value.trim();
    }
  });
  const res = await fetch(`/api/users/${userId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    alert('Failed to update user: ' + (err.detail || res.statusText));
    return;
  }
  const updated = await res.json();
  // Keep paging consistent by refreshing current page
  await fetchUsers();
}

function openPasswordModal(userId) {
  resetUserId = userId;
  document.getElementById('reset_password_input').value = '';
  document.getElementById('passwordModal').style.display = 'flex';
}

function closePasswordModal() {
  document.getElementById('passwordModal').style.display = 'none';
}

async function confirmResetPassword() {
  const newPassword = document.getElementById('reset_password_input').value;
  if (!newPassword) { alert('Enter a new password'); return; }
  const res = await fetch(`/api/users/${resetUserId}/reset_password`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ new_password: newPassword }) });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    alert('Failed to reset password: ' + (err.detail || res.statusText));
    return;
  }
  closePasswordModal();
  alert('Password reset successful');
}

async function deleteUser(userId) {
  if (!confirm('Delete or deactivate this user? If active, they will be deactivated first.')) return;
  const res = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    alert('Failed to delete/deactivate user: ' + (err.detail || res.statusText));
    return;
  }
  // Refresh list
  await fetchUsers();
}

function nextPage() {
  const maxPage = Math.max(1, Math.ceil(totalUsers / pageSize));
  if (currentPage < maxPage) {
    currentPage += 1;
    fetchUsers();
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage -= 1;
    fetchUsers();
  }
}

function applySearch() {
  currentQuery = document.getElementById('search_query').value.trim();
  currentPage = 1;
  fetchUsers();
}

function clearSearch() {
  document.getElementById('search_query').value = '';
  currentQuery = '';
  currentPage = 1;
  fetchUsers();
}

window.addEventListener('DOMContentLoaded', fetchUsers);
</script>
{% endblock %}
